<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-9WM9Z02GWE"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-9WM9Z02GWE');
</script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NBA Player Guess</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-gray-100 flex flex-col items-center min-h-screen p-4">
<!-- Put this anywhere in your base template, e.g., at the end of <body> -->
<div id="cookieConsent" style="display:none;" class="fixed bottom-0 left-0 w-full bg-gray-800 text-white p-4 flex justify-between items-center z-50 shadow-lg">
  <span>
    This website uses cookies to enhance your experience. By continuing to browse, you consent to our use of cookies.
  </span>
  <button id="acceptCookies" class="ml-4 bg-yellow-500 text-black px-3 py-1 rounded font-semibold hover:bg-yellow-400">
    Accept
  </button>
</div>
<script>
  function setCookieConsent() {
    document.cookie = "cookie_consent=1;path=/;max-age=31536000";
  }
  function hasCookieConsent() {
    return document.cookie.split(';').some((c) => c.trim().startsWith('cookie_consent=1'));
  }
  window.onload = function() {
    if (!hasCookieConsent()) {
      document.getElementById('cookieConsent').style.display = "flex";
    }
    document.getElementById('acceptCookies').onclick = function() {
      setCookieConsent();
      document.getElementById('cookieConsent').style.display = "none";
    }
  }
</script>
{% if not current_user.is_authenticated and session.get('show_login_prompt', True) %}
<div id="loginPromptModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
  <div class="bg-gray-800 p-6 rounded-lg max-w-sm w-full text-center space-y-4">
    <h2 class="text-xl font-bold text-yellow-400">Want to appear on the leaderboard?</h2>
    <p class="text-gray-200">Log in or register to be ranked.<br>
    You have declined {{ session.get('prompt_declined_count', 0) }} times today.</p>
    <div class="flex gap-4 justify-center mt-4">
      <a href="{{ url_for('login', next=request.path) }}"
         class="bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded font-semibold text-white">Login/Register</a>
      <button id="declineLoginBtn"
         class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded font-semibold text-white">No, thanks</button>
    </div>
  </div>
</div>
<script>
document.getElementById('declineLoginBtn').onclick = function() {
  fetch('{{ url_for("decline_login_prompt") }}', {method: "POST"}).then(()=>{
    document.getElementById('loginPromptModal').style.display = "none";
    location.reload();
  });
};
</script>
{% endif %}

<div class="mb-4 flex justify-end w-full max-w-2xl">
  {% if current_user.is_authenticated %}
    <span class="mr-4 text-green-300">Logged in as {{ current_user.get_id() }}</span>
    <a href="/logout" class="text-blue-400 underline">Logout</a>
  {% else %}
    <a href="/login" class="text-blue-400 underline">Login</a>
  {% endif %}
</div>

<h1 class="text-3xl font-bold text-yellow-400 mb-4">NBA Player Guess</h1>

<p class="mb-2 text-lg">Time: <span id="timer">0s</span></p>

{% if error %}
<p class="text-red-400 mb-2">{{ error }}</p>
{% endif %}

{% if not max_reached and not (guesses and guesses[-1]['name'] == target_player['name']) %}
<form method="POST" class="mb-4 flex flex-col sm:flex-row gap-2 w-full max-w-xl">
    <input type="text" name="guess" placeholder="Enter player name" list="player_names"
           class="flex-1 px-3 py-2 rounded text-black font-semibold" autofocus required>
    <datalist id="player_names">
        {% for name in player_list %}
        <option value="{{ name }}"></option>
        {% endfor %}
    </datalist>
    <button type="submit" class="bg-yellow-500 hover:bg-yellow-600 px-4 py-2 rounded font-semibold">Guess</button>
</form>
{% endif %}

<!-- Emoji Grid -->
<div class="text-2xl font-bold mt-2 space-y-1 w-full max-w-xl">
  {% for row in emoji_grid %}
    <div class="truncate">{{ row }}</div>
  {% endfor %}
</div>

<!-- Live Table -->
<div class="w-full max-w-4xl mt-4 overflow-x-auto">
  <table class="table-auto border-collapse border border-gray-600 w-full text-center">
    <thead>
      <tr>
        <th class="border border-gray-600 px-2 py-1">Player</th>
        {% for attr in attributes %}
          {% if attr != 'Height' and attr != 'College' %}
            <th class="border border-gray-600 px-2 py-1">{{ attr }}</th>
          {% endif %}
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for g in guesses %}
      <tr>
        <td class="border border-gray-600 px-2 py-1">{{ g['name'] }}</td>
        {% for attr in attributes %}
          {% if attr != 'Height' and attr != 'College' %}
            {% set status, val, arrow = g['result'][attr] %}
            {% if status == 'correct' %}
              <td class="bg-green-500 border border-gray-600 px-2 py-1 font-bold">{{ val }}{{ arrow }}</td>
            {% elif status == 'close' %}
              <td class="bg-yellow-400 border border-gray-600 px-2 py-1 font-bold">{{ val }}{{ arrow }}</td>
            {% else %}
              <td class="bg-gray-800 border border-gray-600 px-2 py-1">{{ val }}{{ arrow }}</td>
            {% endif %}
          {% endif %}
        {% endfor %}
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="mt-4 text-lg text-center">
  <p>Guesses: {{ stats.get('guesses',0) }}</p>
</div>

<!-- Win Modal -->
{% if guesses and guesses[-1]['name'] == target_player['name'] %}
<div id="winningModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
  <div class="bg-gray-800 p-6 rounded-lg max-w-xl w-full text-center space-y-4">
    <h2 class="text-2xl font-bold text-green-400">üèÜ Great, you‚Äôve beaten today‚Äôs challenge!</h2>
    <p>Share your results and come back tomorrow.</p>
    <p class="font-semibold mt-2">The player was <strong>{{ target_player['name'] }}</strong> üèÄ</p>
    <h3 class="font-semibold mt-2">Your Game Summary</h3>
    <div class="text-2xl font-bold mt-2 space-y-1">
      {% for row in emoji_grid %}
        <div class="truncate">{{ row }}</div>
      {% endfor %}
    </div>
    <button id="copyButton" class="bg-yellow-500 hover:bg-yellow-600 px-4 py-2 rounded font-semibold mt-2">
      üìã Copy Results
    </button>
    <p>
      <a href="#" id="todayStatsLink" class="text-blue-400 underline font-semibold">See today's stats &rarr;</a>
      |
      <a href="#" id="weekStatsLink" class="text-blue-400 underline font-semibold">See this week's stats &rarr;</a>
    </p>
  </div>
</div>
{% elif max_reached %}
<div id="losingModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
  <div class="bg-gray-800 p-6 rounded-lg max-w-xl w-full text-center space-y-4">
    <h2 class="text-2xl font-bold text-red-400">Better luck next time. See you tomorrow!</h2>
    <p class="font-semibold mt-2">The player was <strong>{{ target_player['name'] }}</strong> üèÄ</p>
    <h3 class="font-semibold mt-2">Your Game Summary</h3>
    <div class="text-2xl font-bold mt-2 space-y-1">
      {% for row in emoji_grid %}
        <div class="truncate">{{ row }}</div>
      {% endfor %}
    </div>
    <p>
      <a href="#" id="todayStatsLink" class="text-blue-400 underline font-semibold">See today's stats &rarr;</a>
      |
      <a href="#" id="weekStatsLink" class="text-blue-400 underline font-semibold">See this week's stats &rarr;</a>
    </p>
  </div>
</div>
{% endif %}

<script>
let initialElapsed = {{ stats.get('time_elapsed', 0)|round }};
let startTime = Date.now() - initialElapsed * 1000;
let timerEl = document.getElementById('timer');
let timerInterval = setInterval(updateTimer, 1000);

function updateTimer() {
    timerEl.textContent = Math.floor((Date.now() - startTime) / 1000) + "s";
}
updateTimer();

function saveElapsedTimeAndDisable() {
    clearInterval(timerInterval);
    let elapsed = Math.floor((Date.now() - startTime) / 1000);
    console.log("saveElapsedTimeAndDisable: sending elapsed =", elapsed);
    return fetch('/set_time_elapsed', {
        method: "POST",
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({time_elapsed: elapsed})
    }).then(res => {
        if (!res.ok) { console.warn("set_time_elapsed response not ok", res); }
        else { console.log("set_time_elapsed response OK"); }
        return res;
    });
}

{% if guesses and guesses[-1]['name'] == target_player['name'] or max_reached %}
    saveElapsedTimeAndDisable();
{% endif %}

document.getElementById('copyButton')?.addEventListener('click', () => {
    let rows = {{ emoji_grid|tojson }};
    updateTimer();
    let timeText = document.getElementById('timer').textContent.trim();
    let timeMatch = timeText.match(/(\d+)/);
    let timeStr = timeMatch ? timeMatch[1] : "0";
    let text = rows.join('\n') + `\nTime: ${timeStr}s`;
    navigator.clipboard.writeText(text).then(() => {
        alert('Game results copied to clipboard!');
    }).catch(err => {
        alert('Failed to copy: ' + err);
    });
});

document.getElementById('todayStatsLink')?.addEventListener('click', (e) => {
    e.preventDefault();
    saveElapsedTimeAndDisable().then(() => {
        window.location = "/stats";
    });
});
document.getElementById('weekStatsLink')?.addEventListener('click', (e) => {
    e.preventDefault();
    saveElapsedTimeAndDisable().then(() => {
        window.location = "/stats?period=week";
    });
});
</script>
</body>
</html>