<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-9WM9Z02GWE"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-9WM9Z02GWE');
  </script>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NBA Player Guess</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-gray-100 flex flex-col items-center min-h-screen p-4">

  <!-- Cookie Consent -->
  <div id="cookieConsent" style="display:none;" class="fixed bottom-0 left-0 w-full bg-gray-800 text-white p-4 flex justify-between items-center z-50 shadow-lg">
    <span>This website uses cookies to enhance your experience. By continuing to browse, you consent to our use of cookies.</span>
    <button id="acceptCookies" class="ml-4 bg-yellow-500 text-black px-3 py-1 rounded font-semibold hover:bg-yellow-400">
      Accept
    </button>
  </div>
  <script>
    function setCookieConsent() {
      document.cookie = "cookie_consent=1;path=/;max-age=31536000";
    }
    function hasCookieConsent() {
      return document.cookie.split(';').some((c) => c.trim().startsWith('cookie_consent=1'));
    }
    window.onload = function() {
      if (!hasCookieConsent()) {
        document.getElementById('cookieConsent').style.display = "flex";
      }
      document.getElementById('acceptCookies').onclick = function() {
        setCookieConsent();
        document.getElementById('cookieConsent').style.display = "none";
      }
    }
  </script>

  <h1 class="text-3xl font-bold text-yellow-400 mb-4">NBA Player Guess</h1>
  <p class="mb-2 text-lg">Time: <span id="timer">0s</span></p>

  {% if error %}
  <p class="text-red-400 mb-2">{{ error }}</p>
  {% endif %}

  {% if not max_reached and not (guesses and guesses[-1]['name'] == target_player['name']) %}
  <form method="POST" class="mb-4 flex flex-col sm:flex-row gap-2 w-full max-w-xl">
    <input type="text" name="guess" placeholder="Enter player name" list="player_names"
           class="flex-1 px-3 py-2 rounded text-black font-semibold" autofocus required>
    <datalist id="player_names">
      {% for name in player_list %}
      <option value="{{ name }}"></option>
      {% endfor %}
    </datalist>
    <button type="submit" class="bg-yellow-500 hover:bg-yellow-600 px-4 py-2 rounded font-semibold">Guess</button>
  </form>
  {% endif %}

  <!-- Emoji Grid -->
  <div class="text-2xl font-bold mt-2 space-y-1 w-full max-w-xl">
    {% for row in emoji_grid %}
      <div class="truncate">{{ row }}</div>
    {% endfor %}
  </div>

  <!-- Stats Table -->
  <div class="w-full max-w-4xl mt-4 overflow-x-auto">
    <table class="table-auto border-collapse border border-gray-600 w-full text-center">
      <thead>
        <tr>
          <th class="border border-gray-600 px-2 py-1">Player</th>
          {% for attr in attributes %}
            {% if attr != 'Height' and attr != 'College' and attr != 'HT' %}
              <th class="border border-gray-600 px-2 py-1">{{ attr }}</th>
            {% endif %}
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for g in guesses %}
        <tr>
          <td class="border border-gray-600 px-2 py-1">{{ g['name'] }}</td>
          {% for attr in attributes %}
            {% if attr != 'Height' and attr != 'College' and attr != 'HT' %}
              {% set status, val, arrow = g['result'][attr] %}
              {% if status == 'correct' %}
                <td class="bg-green-500 border border-gray-600 px-2 py-1 font-bold">{{ val }}{{ arrow }}</td>
              {% elif status == 'close' %}
                <td class="bg-yellow-400 border border-gray-600 px-2 py-1 font-bold">{{ val }}{{ arrow }}</td>
              {% else %}
                <td class="bg-gray-800 border border-gray-600 px-2 py-1">{{ val }}{{ arrow }}</td>
              {% endif %}
            {% endif %}
          {% endfor %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="mt-4 text-lg text-center">
    <p>Guesses: {{ stats.get('guesses',0) }}</p>
  </div>

  <!-- Win Modal -->
  {% if guesses and guesses[-1]['name'] == target_player['name'] %}
  <div id="winningModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
    <div class="bg-gray-800 p-6 rounded-lg max-w-xl w-full text-center space-y-4">
      <h2 class="text-2xl font-bold text-green-400">üèÜ Great, you‚Äôve beaten today‚Äôs challenge!</h2>
      <p class="font-semibold mt-2">The player was <strong>{{ target_player['name'] }}</strong> üèÄ</p>
      <div class="text-2xl font-bold mt-2 space-y-1">
        {% for row in emoji_grid %}
          <div class="truncate">{{ row }}</div>
        {% endfor %}
      </div>
      <button id="copyButton" class="bg-yellow-500 hover:bg-yellow-600 px-4 py-2 rounded font-semibold mt-2">
        üìã Copy Results
      </button>
      <p class="mt-2">
        <a href="/stats" class="text-blue-400 underline font-semibold">See today's stats ‚Üí</a> |
        <a href="/stats?period=week" class="text-blue-400 underline font-semibold">See this week's stats ‚Üí</a>
      </p>
    </div>
  </div>
  {% elif max_reached %}
  <div id="losingModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
    <div class="bg-gray-800 p-6 rounded-lg max-w-xl w-full text-center space-y-4">
      <h2 class="text-2xl font-bold text-red-400">Better luck next time. See you tomorrow!</h2>
      <p class="font-semibold mt-2">The player was <strong>{{ target_player['name'] }}</strong> üèÄ</p>
      <div class="text-2xl font-bold mt-2 space-y-1">
        {% for row in emoji_grid %}
          <div class="truncate">{{ row }}</div>
        {% endfor %}
      </div>
      <p class="mt-2">
        <a href="/stats" class="text-blue-400 underline font-semibold">See today's stats ‚Üí</a> |
        <a href="/stats?period=week" class="text-blue-400 underline font-semibold">See this week's stats ‚Üí</a>
      </p>
    </div>
  </div>
  {% endif %}

  <script>
    // --- Persistent Timer Logic ---
    const todayKey = "nba_guess_timer_" + new Date().toISOString().slice(0,10);
    let savedElapsed = parseInt(localStorage.getItem(todayKey) || "0");
    let startTime = Date.now() - savedElapsed * 1000;
    let timerEl = document.getElementById("timer");
    let timerInterval = setInterval(updateTimer, 1000);

    function updateTimer() {
      const elapsed = Math.floor((Date.now() - startTime) / 1000);
      timerEl.textContent = elapsed + "s";
      localStorage.setItem(todayKey, elapsed);
    }

    function stopAndSendTime() {
      clearInterval(timerInterval);
      const elapsed = Math.floor((Date.now() - startTime) / 1000);
      localStorage.setItem(todayKey, elapsed);
      fetch("/set_time_elapsed", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ time_elapsed: elapsed })
      });
      return elapsed;
    }

    {% if guesses and guesses[-1]['name'] == target_player['name'] or max_reached %}
      stopAndSendTime();
    {% endif %}

    document.getElementById("copyButton")?.addEventListener("click", () => {
      const rows = {{ emoji_grid|tojson }};
      const elapsed = Math.floor((Date.now() - startTime) / 1000);
      const link = "https://spordle-production.up.railway.app/";
      const text = rows.join("\n") + `\nTime: ${elapsed}s\nPlay here ‚Üí ${link}`;
      navigator.clipboard.writeText(text).then(() => {
        alert("Game results copied to clipboard!");
      });
    });
  </script>
</body>
</html>
